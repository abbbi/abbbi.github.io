---
layout: post
title: PVE 9.0 - Snapshots for LVM
---

The new PVE 9 release advertises a new feature for easier snapshot handling of
virtual machines whose disks are stored on LVM volumes, I wondered.. whats the
deal..?

To be able to use the new feature, you need to enable a special flag for the
LVM volume group. This example shows the general workflow for a fresh setup.

1) Create the volume group with the snapshot-as-volume feature turned on:

{% highlight bash %}
 pvesm add lvm lvmthick --content images --vgname lvm --snapshot-as-volume-chain 1
{% endhighlight %}

2) From this point on, you can create virtual machines right away, BUT those
   virtual machines disks must use the QCOW image format for their disk
   volumes. If you use the RAW format, you wont be possible to create
   snapshots, still.

{% highlight bash %}
 VMID=401
 qm create $VMID --name vm-lvmthick
 qm set $VMID -scsi1 lvmthick:2,format=qcow2
{% endhighlight %}

So, why would it make sense to format the LVM volume as QCOW?

Snapshots on LVM thick provisioned devices are, as everybody knows, a very
I/O intensive task. Besides each snapshot, a special -cow Device is created
that tracks the changed block regions and the original block data for each
change to the active volume. This will waste quite some space within your
volume group for each snapshot.

Formatting the LVM volume as QCOW image, makes it possible to use the QCOW
backing-image option for these devices, this is the way PVE 9 handles these
kind of snapshots.

Creating a snapshot looks like this:

{% highlight bash %}
 qm snapshot $VMID id
 snapshotting 'drive-scsi1' (lvmthick3:vm-401-disk-0.qcow2)
 Renamed "vm-401-disk-0.qcow2" to "snap_vm-401-disk-0_id.qcow2" in volume group "lvm"
 Rounding up size to full physical extent 1.00 GiB
 Logical volume "vm-401-disk-0.qcow2" created.
 Formatting '/dev/lvm/vm-401-disk-0.qcow2', fmt=qcow2 cluster_size=131072 extended_l2=on preallocation=metadata compression_type=zlib size=1073741824 backing_file=snap_vm-401-disk-0_id.qcow2 backing_fmt=qcow2 lazy_refcounts=off refcount_bits=16
{% endhighlight %}

So it will rename the current active disk and create another QCOW formatted LVM
volume, but pointing it to the snapshot image using the backing_file option.

Neat.
